<link rel="stylesheet" href="{{ @CDN }}/admin/css/admin_toolbar.css">
<script src="{{ @CDN }}/jquery/jquery-3.2.1.min.js"></script>
<script>
function PopupCenter(url, title, w, h) {
    // Fixes dual-screen position                         Most browsers      Firefox
    var dualScreenLeft = window.screenLeft != undefined ? window.screenLeft : screen.left;
    var dualScreenTop = window.screenTop != undefined ? window.screenTop : screen.top;

    var width = window.innerWidth ? window.innerWidth : document.documentElement.clientWidth ? document.documentElement.clientWidth : screen.width;
    var height = window.innerHeight ? window.innerHeight : document.documentElement.clientHeight ? document.documentElement.clientHeight : screen.height;

    var left = ((width / 2) - (w / 2)) + dualScreenLeft;
    var top = ((height / 2) - (h / 2)) + dualScreenTop;
    var newWindow = window.open(url, title, 'scrollbars=yes, width=' + w + ', height=' + h + ', top=' + top + ', left=' + left);

    // Puts focus on the newWindow
    if (window.focus) {
        newWindow.focus();
    }
}

function closeRefresh() {
  window.close();
  window.onunload = function () { window.opener.location.reload(); }
}

var cmsjQuery = jQuery.noConflict(true);

cmsjQuery(function() {

	var main_div = cmsjQuery('<div>').attr('id', 'webworkscms_admintoolbar');
	cmsjQuery('body').append(main_div);

	var left_div = cmsjQuery('<div>').attr('id', 'left_div');
	main_div.append(left_div);

	main_div.append(cmsjQuery('<div>').attr('id', 'center_div'));
  main_div.append(cmsjQuery('<div>').attr('id', 'status_div'));

	var right_div = cmsjQuery('<div>').attr('id', 'right_div');
	main_div.append(right_div);

  left_div.append(cmsjQuery('<img id="webworks_logo" src="{{ @CDN }}/admin/imgs/logo_toolbar.png" height="100%">'));

  right_div.append(cmsjQuery('<a href="{{@BASE}}/admin/settings" id="settingsbtn" class="button">Settings</a>'));
  right_div.append(cmsjQuery('<a href="{{@BASE}}{{@PATH}}/logout" class="button">Logout</a>'));

  function status (message) {
    cmsjQuery("#webworkscms_admintoolbar #center_div").hide();
    cmsjQuery("#webworkscms_admintoolbar #status_div").show();
    
    cmsjQuery("#webworkscms_admintoolbar #status_div").html(message);
  }

  status("testing");

  var mouseX = 0;
  var mouseY = 0;

  cmsjQuery(".editable").append(cmsjQuery("<div class='top border'></div><div class='left border'></div><div class='right border'></div><div class='bottom border'></div>"));

  var editors = document.getElementsByClassName("editable");
  for (var i = editors.length - 1; i >= 0; i--)
  {
      cmsjQuery(editors[i]).next().addClass("cmseditable").attr("editor_id", "#"+cmsjQuery(editors[i]).attr("id"));
  }
  
  cmsjQuery(".cmseditable").mousemove(function (evt) {
      var editor = cmsjQuery(cmsjQuery(evt.currentTarget).attr("editor_id"));

      editor.width(evt.currentTarget.clientWidth);           
      editor.css({top: cmsjQuery(evt.currentTarget).position().top, left: cmsjQuery(evt.currentTarget).position().left, height: 1});

      var top = editor.children(".top");
      // editor.children(".top").width(evt.currentTarget.clientWidth).css({top: 0, left: 0});
      // editor.children(".left").height(evt.currentTarget.clientHeight).css({top: 0, left: 0});
      // editor.children(".bottom").width(evt.currentTarget.clientWidth).css({top: evt.currentTarget.clientHeight, left: 0});
      // editor.children(".right").height(evt.currentTarget.clientHeight).css({top: 0, left: evt.currentTarget.clientWidth-10});

      cmsjQuery(evt.currentTarget).css("outline", "10px solid #3682E3");

      editor.show();

  });

  setInterval(function () {
      var editors = document.getElementsByClassName("editable");

      for (var i = editors.length - 1; i >= 0; i--)
      {
          var nextelement = cmsjQuery(editors[i]).next();

          if (mouseY <= nextelement.position().top || mouseY >= (nextelement.height()+nextelement.position().top))
          {
              nextelement.css("outline", "none");
              cmsjQuery(editors[i]).hide();
          }
          else if (mouseX <= nextelement.offset().left || mouseX >= (nextelement.offset().left+nextelement.width()))
          {
              nextelement.css("outline", "none");
              cmsjQuery(editors[i]).hide();
          }
      }
  }, 500);

  cmsjQuery(".editable .toolbar .button, #webworkscms_admintoolbar #settingsbtn").click(function (evt) {

    var label = $(this).html();

    $(this).html("Opening");

    PopupCenter($(this).attr("href"), "Webworks CMS", "1000", "800");

    $(this).html(label);

    evt.preventDefault();
  });


  cmsjQuery(window).mousemove(function (evt) {
      mouseX = evt.pageX;
      mouseY = evt.pageY;
  });
});
</script>

<repeat group="{{@include}}" value="{{@code}}">
{{@code}}
</repeat>