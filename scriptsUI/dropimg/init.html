<style>
    .imgdropzone {
        transition: opacity 0.1s ease-in-out 0s !important;
    }

    .imgdropzone:hover { 
        outline: 1px dashed #777;
        opacity: 0.3 !important;
    }
</style>

<script src="{{ @CDN }}/dropzone/dist/min/dropzone.min.js"></script>
<script>
    cmsjQuery(function() {

        var imgs_for_dropzone = document.getElementsByClassName("imgdropzone");

        for (var i = imgs_for_dropzone.length - 1; i >= 0; i--)
        {
            var id = imgs_for_dropzone[i].getAttribute("id");
            var width = imgs_for_dropzone[i].getAttribute("data-width");
            var height = imgs_for_dropzone[i].getAttribute("data-height");
            var mime = imgs_for_dropzone[i].getAttribute("data-mime");

            var file = imgs_for_dropzone[i].getAttribute("data-file");
            var brightness = imgs_for_dropzone[i].getAttribute("data-brightness");
            var contrast = imgs_for_dropzone[i].getAttribute("data-contrast");

            var dz = new Dropzone("#"+id, { 
                url: "{{@BASE}}/admin/dropimg/upload",
                params: {
                    width: width,
                    height: height,
                    file: file,
                    brightness: brightness,
                    contrast: contrast
                },
                resizeWidth: width,
                resizeHeight: height,
                resizeMimeType: mime,
                resizeMethod: "crop",
                createImageThumbnails: false,
                uploadMultiple: false,
                init: function () {
                    this.on("complete", function (file) {
                        this.element.src = this.element.src+"?"+new Date().getTime(); 
                    });

                    this.on("drop", function(evt) {
                        var that = this;
                        var url = evt.dataTransfer.getData('URL');

                        if (url != "") {
                            var xhttp = new XMLHttpRequest();
                            xhttp.open("POST", "{{@BASE}}/admin/dropimg/upload_from_url", true);
                            xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                            xhttp.onreadystatechange = function() {
                                if (this.readyState == 4 && this.status == 200) {
                                   that.element.src = that.element.src+"?"+new Date().getTime();
                                   console.log(that.element.src+"?"+new Date().getTime());
                                }
                            };

                            xhttp.send("url="+url+"&file="+this.element.getAttribute("data-file")+"&width="+this.element.getAttribute("data-width")+"&height="+this.element.getAttribute("data-height")); 
                        }
                    });
                }
            });
        }
    });
</script>
